# WP Scan 404 Debugging

## Status: INVESTIGATING

---

## What We Know

### ✅ Database is Correct
Ran `scripts/check-wpscan.ts`:
- Product exists: `wp-scan` (ID: e38723ae-42c9-4516-93ec-1448ae6d8b1d)
- Type: `subscription`
- All 6 pricing tiers exist:
  - ✅ pro-monthly: $49
  - ✅ pro-yearly: $441
  - ✅ agency-monthly: $149
  - ✅ agency-yearly: $1,341
  - ✅ enterprise-monthly: $499
  - ✅ enterprise-yearly: $4,491

### ✅ Button Implementation is Correct
```tsx
<UnifiedCheckoutButton
  productSlug="wp-scan"
  tierName={`${plan.name.toLowerCase()}-${billingCycle}`}
  // Examples: "pro-monthly", "agency-yearly"
>
  {plan.cta}
</UnifiedCheckoutButton>
```

Tier names generated by buttons MATCH database exactly.

### ❌ User Reports 404 Error
- Clicks "Get Started" on WP Scan Pro or Agency
- Opens Stripe URL: `https://checkout.stripe.com/c/pay/cs_test_wpscan_`
- Gets 404: "Page not found"

---

## Problem Analysis

### Invalid Session ID Format
Normal Stripe session IDs look like:
- `cs_test_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0...`
- `cs_live_a1b2c3d4e5f6...`

But user sees:
- `cs_test_wpscan_` ❌

This is **NOT** a valid Stripe session ID!

### Possible Causes

1. **Stripe API Key Missing/Invalid**
   - If `STRIPE_SECRET_KEY` is not set or invalid
   - Stripe API call fails
   - No session ID returned
   - Placeholder/fallback URL used?

2. **API Error Swallowed**
   - Checkout API catches error but returns partial response
   - Frontend gets invalid URL
   - User redirected to broken Stripe page

3. **Environment Variable Not Loaded**
   - `.env.local` not being read correctly
   - Stripe library throws error
   - Session creation fails silently

---

## Investigation Steps

### Step 1: Check Stripe Keys ✅
Run:
```bash
Get-Content .env.local | Select-String "STRIPE"
```

Should have:
- `STRIPE_SECRET_KEY=sk_test_...` (starts with sk_test_ or sk_live_)
- `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...`

### Step 2: Test API Call Directly
Create test script to call `/api/checkout/dynamic`:

```typescript
const response = await fetch('http://localhost:3000/api/checkout/dynamic', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    productSlug: 'wp-scan',
    tierName: 'pro-monthly',
    quantity: 1,
  }),
});

const data = await response.json();
console.log('Response:', data);
```

Expected success response:
```json
{
  "success": true,
  "sessionId": "cs_test_a1b2c3d4...",
  "url": "https://checkout.stripe.com/c/pay/cs_test_a1b2c3d4...",
  "product": {
    "name": "WordPress Security Scanner",
    "tier": "Pro Monthly"
  }
}
```

Expected error response:
```json
{
  "error": "Product not found",
  "status": 404
}
```

### Step 3: Check API Route Error Handling
In `/app/api/checkout/dynamic/route.ts`, verify:
1. Product found check
2. Pricing tier found check  
3. Stripe session creation error handling
4. Return value validation

### Step 4: Add Logging
Temporarily add console.logs to API route:

```typescript
console.log('Product found:', product);
console.log('Pricing tier found:', pricingTier);
console.log('Creating Stripe session...');
const stripeSession = await createSingleProductCheckout(...);
console.log('Stripe session created:', stripeSession.id, stripeSession.url);
```

---

## Next Actions

1. **Verify Stripe keys exist in .env.local**
2. **Test API endpoint directly** (with dev server running)
3. **Check browser console** for errors when clicking button
4. **Check server logs** when button is clicked
5. **Verify Stripe dashboard** - are test sessions being created?

---

## Likely Solution

Based on the invalid session ID format `cs_test_wpscan_`, this is almost certainly:

**Stripe API Key Issue**
- Key is missing, invalid, or expired
- Stripe API call fails
- No real session ID generated
- System returns placeholder/fallback

**Fix:**
1. Get valid Stripe test API key from dashboard.stripe.com
2. Update `STRIPE_SECRET_KEY` in `.env.local`
3. Restart dev server
4. Test checkout again

---

## Comparison with Working Checkouts

SEO Services works correctly - this tells us:
- Database connection: ✅ Working
- API route: ✅ Working
- Stripe library: ✅ Installed
- Basic checkout flow: ✅ Working

So the issue is specific to either:
- WP Scan product type (`subscription` vs `service`)
- Or just a timing issue (user tested WP Scan before database was seeded)

---

## Testing Plan

1. **Browser DevTools:**
   - Open /wp-scan/plans
   - Open Network tab
   - Click "Upgrade to Pro"
   - Check request to `/api/checkout/dynamic`
   - Check response (should have sessionId and url)
   - If response looks good but redirect fails = Frontend issue
   - If response has error = Backend issue

2. **Server Logs:**
   - Run `npm run dev`
   - Watch console output
   - Click checkout button
   - Look for errors like:
     - "Product not found"
     - "Pricing tier not found"
     - "Stripe API error"
     - "STRIPE_SECRET_KEY is not set"

3. **Database Check:**
   - Already verified ✅
   - Product and tiers exist
   - This is not the issue

---

**Status:** Need to verify Stripe API keys and check actual API response
